<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <style>@import url('https://fonts.googleapis.com/css?family=Roboto:300');

* {
  box-sizing: border-box;
  font-family: 'Roboto', sans-serif;
}

table {
  width: 100%;
  font-size: 14px;
  color: black;
}

thead {
  background-color: gray;
  color: white;
}

th,
 td {
  border: 0;
  border-bottom: 1px solid gray;
  height: 50px;
  border-right: 1px solid gray;
  text-align: center;
}

a {
  width: 100%;
  height: 100%;
  display: block;
  text-align: center;
  padding-top: 15px;
  color: inherit;
  text-decoration: none;
  font-weight: bold;
}

a:hover {
  background-color: black;
  color: white;
}

select {
  width: 38%;
  height: 100%;
}

textarea {
  display: block;
  margin: 0 auto;
  width: 99%;
  height: 100%;
}</style>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <title>ha.ze.gs</title>
  </head>
  <body>
    <table>
      <thead>
        <tr>
          <th>Switch</th>
          <th><a href="#" data-api='["hue","lights","off"]'>All light OFF</a></th>
          <th>&nbsp;</th>
          <th>&nbsp;</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td id="Living">Living</td>
          <td><a href="#" data-api='["switchbot-command","-d","02-202102231815-37239298","-c","turnOn"]'>On/Off</a></td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td id="Dining">Dining</td>
          <td><a href="#" data-api='["hue","lights","13,14,15,28,29","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="#" data-api='["hue","lights","13,14,15,28,29","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Tatami">Tatami</td>
          <td><a href="#" data-api='["switchbot-command","-d","ECCC4C8C52C3","-c","turnOn"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="#" data-api='["switchbot-command","-d","ECCC4C8C52C3","-c","turnOff"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Downright">Down right</td>
          <td><a href="#" data-api='["hue","lights","27","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="#" data-api='["hue","lights","27","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Downleft">Down left</td>
          <td><a href="#" data-api='["hue","lights","26","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="#" data-api='["hue","lights","26","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Downback">Down back</td>
          <td><a href="#" data-api='["hue","lights","7","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="#" data-api='["hue","lights","7","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Washroom">Washroom</td>
          <td><a href="#" data-api='["hue","lights","22","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="#" data-api='["hue","lights","22","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Bathroom">Bathroom</td>
          <td><a href="#" data-api='["hue","lights","8,9","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="#" data-api='["hue","lights","8,9","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Corridor">Corridor</td>
          <td><a href="#" data-api='["hue","lights","21,16","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="#" data-api='["hue","lights","21,16","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Restroom">Restroom</td>
          <td><a href="#" data-api='["hue","lights","10","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="#" data-api='["hue","lights","10","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Chiemi">Chiemi</td>
          <td><a href="#" data-api='["hue","lights","18,19,20","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="#" data-api='["hue","lights","18,19,20","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="AC">
            <a href="#" data-fetch="https://script.google.com/macros/s/AKfycbyedXl6ic-uZR0LDrWgpw9madWl0374RNxz7EIB1m4wMnYsVZnT3rfVt4OQ8tDb1R8YOQ/exec?s=status&t=control">A/C</a>
          </td>
          <td>
            <a
              href="#"
              data-api='["switchbot-ac","-d","02-202307290753-22894539","-a","28,2,1,on"]'
              data-fetch="https://script.google.com/macros/s/AKfycbyedXl6ic-uZR0LDrWgpw9madWl0374RNxz7EIB1m4wMnYsVZnT3rfVt4OQ8tDb1R8YOQ/exec?s=status&t=cool"
              >Cool</a
            >
          </td>
          <td>
            <a
              href="#"
              data-api='["switchbot-ac","-d","02-202307290753-22894539","-a","28,5,1,on"]'
              data-fetch="https://script.google.com/macros/s/AKfycbyedXl6ic-uZR0LDrWgpw9madWl0374RNxz7EIB1m4wMnYsVZnT3rfVt4OQ8tDb1R8YOQ/exec?s=status&t=hot"
              >Hot</a
            >
          </td>
          <td>
            <a
              href="#"
              data-api='["switchbot-ac","-d","02-202307290753-22894539","-a","25,2,1,off"]'
              data-fetch="https://script.google.com/macros/s/AKfycbyedXl6ic-uZR0LDrWgpw9madWl0374RNxz7EIB1m4wMnYsVZnT3rfVt4OQ8tDb1R8YOQ/exec?s=status&t=off"
              >Off</a
            >
          </td>
        </tr>
        <tr>
          <td id="TatamiAC">Tatami A/C</td>
          <td><a href="#" data-api='["switchbot-custom","-d","03-202401251013-58699638","-c","Cool"]'>Cool</a></td>
          <td><a href="#" data-api='["switchbot-custom","-d","03-202401251013-58699638","-c","Hot"]'>Hot</a></td>
          <td><a href="#" data-api='["switchbot-custom","-d","03-202401251013-58699638","-c","Off"]'>Off</a></td>
        </tr>
        <tr>
          <td>Tool</td>
          <td><a href="#" data-api='["switchbot-command","-d","D23403D2D43D","-c","press"]'>HeatFloor</a></td>
          <td>&nbsp;</td>
          <td>
            <a
              href="#"
              data-api='["google-home-speaker-wrapper","-h","192.168.1.22","-v",60,"-s","%E3%83%81%E3%82%A8%E3%83%9F%E3%81%95%E3%82%93%E3%80%81%E3%83%9E%E3%83%9E%E3%81%95%E3%82%93%E3%80%81%E3%83%91%E3%83%91%E3%81%8C%E5%88%B0%E7%9D%80%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82%E6%BA%96%E5%82%99%E3%82%92%E3%81%8A%E9%A1%98%E3%81%84%E3%81%97%E3%81%BE%E3%81%99%E3%80%82"]'
              >CarArrives</a
            >
          </td>
        </tr>
        <tr>
          <td id="Fan">Fan</td>
          <td><a href="#" data-api='["switchbot-command","-d","03-202401251013-89002900","-c","turnOn"]'>On/Off</a></td>
          <td><a href="#" data-api='["switchbot-command","-d","03-202401251013-89002900","-c","highSpeed"]'>Turbo</a></td>
          <td><a href="#" data-api='["switchbot-command","-d","03-202401251013-89002900","-c","swing"]'>Swing</a></td>
        </tr>
        <tr>
          <td id="NW">Nest WiFi</td>
          <td><a href="#" data-api='["catt","-d","192.168.1.22","volumeup"]'>+</a></td>
          <td><a href="#" data-api='["catt","-d","192.168.1.22","volumedown"]'>-</a></td>
          <td><a href="#" data-api='["catt","-d","192.168.1.22","stop"]'>Off</a></td>
        </tr>
        <tr>
          <td id="TW">Tatami WiFi</td>
          <td><a href="#" data-api='["catt","-d","192.168.1.236","volumeup"]'>+</a></td>
          <td><a href="#" data-api='["catt","-d","192.168.1.236","volumedown"]'>-</a></td>
          <td><a href="#" data-api='["catt","-d","192.168.1.236","stop"]'>Off</a></td>
        </tr>
        <tr>
          <td id="CC">TV</td>
          <td><a href="#" data-api='["catt","-d","192.168.1.219","volumeup"]'>+</a></td>
          <td><a href="#" data-api='["catt","-d","192.168.1.219","volumedown"]'>-</a></td>
          <td><a href="#" data-api='["catt","-d","192.168.1.219","stop"]'>Off</a></td>
        </tr>
        <tr>
          <td id="YouTube"><a href="#" data-youtube-host="192.168.1.219">YouTube</a></td>
          <td><textarea id="youtube_url"></textarea></td>
          <td><a href="#" data-youtube-host="192.168.1.22">Nest Wifi</a></td>
          <td><a href="#" data-youtube-host="192.168.1.236">Tatami WiFi</a></td>
        </tr>
        <tr>
          <td id="Voice">Voice</td>
          <td><textarea id="voicetext"></textarea></td>
          <td><a id="speak" href="#">Nest Wifi</a></td>
          <td><a id="speak_tatami" href="#">Tatami</a></td>
        </tr>
        <tr>
          <td id="YouTube">GPT</td>
          <td><textarea id="prompt"></textarea></td>
          <td><a href="#" data-gpt-host="192.168.1.22">Nest Wifi</a></td>
          <td><a href="#" data-gpt-host="192.168.1.236">Tatami WiFi</a></td>
        </tr>
        <tr>
          <td id="Alarm">Alarm</td>
          <td>
            <select id="hour">
              <option value="00">00</option>
              <option value="01">01</option>
              <option value="02">02</option>
              <option value="03">03</option>
              <option value="04">04</option>
              <option value="05">05</option>
              <option value="06">06</option>
              <option value="07">07</option>
              <option value="08">08</option>
              <option value="09">09</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
              <option value="17">17</option>
              <option value="18">18</option>
              <option value="19">19</option>
              <option value="20">20</option>
              <option value="21">21</option>
              <option value="22">22</option>
              <option value="23">23</option>
            </select>
            :
            <select id="min">
              <option value="00">00</option>
              <option value="01">01</option>
              <option value="02">02</option>
              <option value="03">03</option>
              <option value="04">04</option>
              <option value="05">05</option>
              <option value="06">06</option>
              <option value="07">07</option>
              <option value="08">08</option>
              <option value="09">09</option>
              <option value="10">10</option>
              <option value="11">11</option>
              <option value="12">12</option>
              <option value="13">13</option>
              <option value="14">14</option>
              <option value="15">15</option>
              <option value="16">16</option>
              <option value="17">17</option>
              <option value="18">18</option>
              <option value="19">19</option>
              <option value="20">20</option>
              <option value="21">21</option>
              <option value="22">22</option>
              <option value="23">23</option>
              <option value="24">24</option>
              <option value="25">25</option>
              <option value="26">26</option>
              <option value="27">27</option>
              <option value="28">28</option>
              <option value="29">29</option>
              <option value="30">30</option>
              <option value="31">31</option>
              <option value="32">32</option>
              <option value="33">33</option>
              <option value="34">34</option>
              <option value="35">35</option>
              <option value="36">36</option>
              <option value="37">37</option>
              <option value="38">38</option>
              <option value="39">39</option>
              <option value="40">40</option>
              <option value="41">41</option>
              <option value="42">42</option>
              <option value="43">43</option>
              <option value="44">44</option>
              <option value="45">45</option>
              <option value="46">46</option>
              <option value="47">47</option>
              <option value="48">48</option>
              <option value="49">49</option>
              <option value="50">50</option>
              <option value="51">51</option>
              <option value="52">52</option>
              <option value="53">53</option>
              <option value="54">54</option>
              <option value="55">55</option>
              <option value="56">56</option>
              <option value="57">57</option>
              <option value="58">58</option>
              <option value="59">59</option>
            </select>
          </td>
          <td><textarea id="alarmtext"></textarea></td>
          <td><a id="set" href="#">Set</a></td>
        </tr>
        <tr>
          <td><a href="http://g.ze.gs/nasne_home/index_pc.html" target="_blank">nasne</a></td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
        </tr>
        <tr>
          <td id="AirCondition">AirCondition</td>
          <td id="Datetime">&nbsp;</td>
          <td id="Temperature">&nbsp;</td>
          <td id="Humidity">&nbsp;</td>
        </tr>
      </tbody>
    </table>

    <script>const apiUrl = (args) => `http://a.ze.gs/${args.join("/")}`;

const buildVoiceUrls = (voiceText) => {
  const sanitized = encodeURIComponent(voiceText.replace(/[\s\n\r]/g, ""));
  return {
    speak: `http://a.ze.gs/google-home-speaker-wrapper/-h/192.168.1.22/-v/60/-s/${sanitized}`,
    speakTatami: `http://a.ze.gs/google-home-speaker-wrapper/-h/192.168.1.236/-v/60/-s/${sanitized}`,
  };
};

const updateVoiceLinks = (voiceText, elements) => {
  const { speak, speakTatami } = buildVoiceUrls(voiceText);
  elements.speak.dataset.url = speak;
  elements.speakTatami.dataset.url = speakTatami;
  elements.speak.setAttribute("href", "#");
  elements.speakTatami.setAttribute("href", "#");
};

const buildAlarmUrl = (hour, minute, text) => {
  const sanitized = encodeURIComponent(text.replace(/[\s\n\r]/g, ""));
  return `https://script.google.com/macros/s/AKfycbyGtgeNC_rHFxPvSj7XjO5GdM6awoqlxJ7PDmfcadghjZshQ8Y/exec?time=${hour}:${minute}:00&text=${sanitized}`;
};

const parseYouTubeId = (youtubeUrl) => {
  if (youtubeUrl.match(/^https:\/\/youtu.be\//)) {
    return youtubeUrl.split("/")[3];
  }

  if (youtubeUrl.match(/^https:\/\/(music|www|m).youtube.com\/watch\?v=/)) {
    const videoId = youtubeUrl.split("v=")[1];
    const ampersandPosition = videoId.indexOf("&");
    return ampersandPosition !== -1 ? videoId.substring(0, ampersandPosition) : videoId;
  }

  if (youtubeUrl.match(/^https:\/\/(www\.)?youtube.com\/(live|shorts)\//)) {
    return youtubeUrl.split("/")[4].split("?")[0];
  }

  return "";
};

const buildYouTubePlayUrl = (host, youtubeUrl) => {
  const videoId = parseYouTubeId(youtubeUrl);
  return { videoId, url: `http://a.ze.gs/youtube-play/-h/${host}/-v/40/-i/${videoId}` };
};

const buildGptUrl = (host, prompt) =>
  `https://hook.us1.make.com/7zekvch82ird62gydqbu356ncnkx05z9?p=${prompt}&i=${host}`;

const parseLatestPayload = (payload) => {
  const cleaned = payload.replace(/^a&&a\(/, "").replace(/\);$/, "");
  return JSON.parse(cleaned).pop();
};

const fetchLatestStatus = async (fetcher) => {
  const response = await fetcher(
    "https://script.google.com/macros/s/AKfycbyedXl6ic-uZR0LDrWgpw9madWl0374RNxz7EIB1m4wMnYsVZnT3rfVt4OQ8tDb1R8YOQ/exec?callback=a",
  );
  const payload = await response.text();
  return parseLatestPayload(payload);
};

const updateStatusCells = (latest, elements) => {
  ["Datetime", "Temperature", "Humidity"].forEach((target) => {
    elements[target].innerText = latest[target];
  });
};

const initApp = (doc, fetcher = fetch) => {
  const voicetext = doc.getElementById("voicetext");
  const speak = doc.getElementById("speak");
  const speakTatami = doc.getElementById("speak_tatami");
  const hour = doc.getElementById("hour");
  const min = doc.getElementById("min");
  const alarmtext = doc.getElementById("alarmtext");
  const setButton = doc.getElementById("set");
  const youtubeUrl = doc.getElementById("youtube_url");
  const prompt = doc.getElementById("prompt");

  const statusCells = {
    Datetime: doc.getElementById("Datetime"),
    Temperature: doc.getElementById("Temperature"),
    Humidity: doc.getElementById("Humidity"),
  };

  if (!voicetext || !speak || !speakTatami || !hour || !min || !alarmtext || !setButton) {
    return null;
  }

  voicetext.addEventListener("input", () => {
    updateVoiceLinks(voicetext.value, { speak, speakTatami });
  });

  const setAlarm = () => {
    const url = buildAlarmUrl(hour.value, min.value, alarmtext.value);
    return fetcher(url);
  };

  const youtubePlay = (host) => {
    if (!youtubeUrl) {
      return null;
    }
    const { url } = buildYouTubePlayUrl(host, youtubeUrl.value);
    return fetcher(url);
  };

  const gpt = (host) => {
    if (!prompt) {
      return null;
    }
    return fetcher(buildGptUrl(host, prompt.value));
  };

  const fetchLatest = async () => {
    if (!statusCells.Datetime || !statusCells.Temperature || !statusCells.Humidity) {
      return null;
    }
    const latest = await fetchLatestStatus(fetcher);
    updateStatusCells(latest, statusCells);
    return latest;
  };

  return {
    setAlarm,
    youtubePlay,
    gpt,
    fetchLatest,
    elements: {
      voicetext,
      speak,
      speakTatami,
      hour,
      min,
      alarmtext,
      setButton,
      youtubeUrl,
      prompt,
      statusCells,
    },
  };
};

const _sleep = (sec, cb) => {
  let id = 0;
  const wait = () => {
    if (sec-- <= 0 && typeof cb === "function") {
      cb();
      return;
    }
    if (id > 0) {
      clearTimeout(id);
    }
    id = setTimeout(wait, 1000);
  };
  id = setTimeout(wait, 0);
  return () => clearTimeout(id);
};

const start = (doc = document, fetcher = fetch) => {
  const instance = initApp(doc, fetcher);
  if (!instance) {
    return null;
  }

  const { setAlarm, youtubePlay, gpt, fetchLatest, elements } = instance;

  elements.setButton.addEventListener("click", (event) => {
    event.preventDefault();
    setAlarm();
  });

  doc.querySelectorAll("a[data-api], a[data-fetch]").forEach((link) => {
    link.addEventListener("click", (event) => {
      event.preventDefault();
      const apiArgs = link.dataset.api ? JSON.parse(link.dataset.api) : null;
      if (apiArgs) {
        fetcher(apiUrl(apiArgs));
      }
      if (link.dataset.fetch) {
        fetcher(link.dataset.fetch);
      }
    });
  });

  doc.querySelectorAll("a[data-youtube-host]").forEach((link) => {
    link.addEventListener("click", (event) => {
      event.preventDefault();
      const host = link.dataset.youtubeHost;
      if (host) {
        youtubePlay(host);
      }
    });
  });

  doc.querySelectorAll("a[data-gpt-host]").forEach((link) => {
    link.addEventListener("click", (event) => {
      event.preventDefault();
      const host = link.dataset.gptHost;
      if (host) {
        gpt(host);
      }
    });
  });

  [elements.speak, elements.speakTatami].forEach((link) => {
    link.addEventListener("click", (event) => {
      event.preventDefault();
      if (link.dataset.url) {
        fetcher(link.dataset.url);
      }
    });
  });

  fetchLatest();

  return instance;
};

if (typeof window !== "undefined") {
  const instance = start(document, fetch);

  window.api = (args) => {
    fetch(apiUrl(args));
  };

  window.setAlarm = () => instance?.setAlarm();
  window.youtubePlay = (host) => instance?.youtubePlay(host);
  window.gpt = (host) => instance?.gpt(host);
}</script>
  </body>
</html>
