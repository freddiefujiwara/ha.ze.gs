<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <style>@import url('https://fonts.googleapis.com/css?family=Roboto:300');

* {
  box-sizing: border-box;
  font-family: 'Roboto', sans-serif;
}

table {
  width: 100%;
  font-size: 14px;
  color: black;
}

thead {
  background-color: gray;
  color: white;
}

th,
 td {
  border: 0;
  border-bottom: 1px solid gray;
  height: 50px;
  border-right: 1px solid gray;
  text-align: center;
}

a {
  width: 100%;
  height: 100%;
  display: block;
  text-align: center;
  padding-top: 15px;
  color: inherit;
  text-decoration: none;
  font-weight: bold;
}

a:hover {
  background-color: black;
  color: white;
}

select {
  width: 38%;
  height: 100%;
}

textarea {
  display: block;
  margin: 0 auto;
  width: 99%;
  height: 100%;
}</style>
    <title>ha.ze.gs</title>
  </head>
  <body>
    <table>
      <thead>
        <tr>
          <th>Switch</th>
          <th>
            <a
              href="http://a.ze.gs/hue/lights/off?url=http://ha.ze.gs"
              data-api='[["hue","lights","off"],["switchbot-command","-d","C70C0516C0C7","-c","turnOff"],["switchbot-command","-d","ECCC4C8C52C3","-c","turnOff"],["switchbot-ac","-d","02-202307290753-22894539","-a","25,2,1,off"],["switchbot-custom","-d","03-202401251013-58699638","-c","Off"]]'
              data-status-action="control"
              >Go Out</a
            >
          </th>
          <th>&nbsp;</th>
          <th>&nbsp;</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td id="Living">Living</td>
          <td><a href="http://a.ze.gs/switchbot-command/-d/C70C0516C0C7/-c/turnOn?url=http://ha.ze.gs" data-api='["switchbot-command", "-d", "C70C0516C0C7", "-c", "turnOn"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="http://a.ze.gs/switchbot-command/-d/C70C0516C0C7/-c/turnOff?url=http://ha.ze.gs" data-api='["switchbot-command", "-d", "C70C0516C0C7", "-c", "turnOff"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Dining">Dining</td>
          <td><a href="http://a.ze.gs/hue/lights/13,14,15,28,29/on?url=http://ha.ze.gs" data-api='["hue","lights","13,14,15,28,29","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="http://a.ze.gs/hue/lights/13,14,15,28,29/off?url=http://ha.ze.gs" data-api='["hue","lights","13,14,15,28,29","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Tatami">Tatami</td>
          <td><a href="http://a.ze.gs/switchbot-command/-d/ECCC4C8C52C3/-c/turnOn?url=http://ha.ze.gs" data-api='["switchbot-command","-d","ECCC4C8C52C3","-c","turnOn"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="http://a.ze.gs/switchbot-command/-d/ECCC4C8C52C3/-c/turnOff?url=http://ha.ze.gs" data-api='["switchbot-command","-d","ECCC4C8C52C3","-c","turnOff"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Downright">Down right</td>
          <td><a href="http://a.ze.gs/hue/lights/27/on?url=http://ha.ze.gs" data-api='["hue","lights","27","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="http://a.ze.gs/hue/lights/27/off?url=http://ha.ze.gs" data-api='["hue","lights","27","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Downleft">Down left</td>
          <td><a href="http://a.ze.gs/hue/lights/26/on?url=http://ha.ze.gs" data-api='["hue","lights","26","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="http://a.ze.gs/hue/lights/26/off?url=http://ha.ze.gs" data-api='["hue","lights","26","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Downback">Down back</td>
          <td><a href="http://a.ze.gs/hue/lights/7/on?url=http://ha.ze.gs" data-api='["hue","lights","7","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="http://a.ze.gs/hue/lights/7/off?url=http://ha.ze.gs" data-api='["hue","lights","7","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Washroom">Washroom</td>
          <td><a href="http://a.ze.gs/hue/lights/22/on?url=http://ha.ze.gs" data-api='["hue","lights","22","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="http://a.ze.gs/hue/lights/22/off?url=http://ha.ze.gs" data-api='["hue","lights","22","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Bathroom">Bathroom</td>
          <td><a href="http://a.ze.gs/hue/lights/8,9/on?url=http://ha.ze.gs" data-api='["hue","lights","8,9","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="http://a.ze.gs/hue/lights/8,9/off?url=http://ha.ze.gs" data-api='["hue","lights","8,9","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Corridor">Corridor</td>
          <td><a href="http://a.ze.gs/hue/lights/21,16/on?url=http://ha.ze.gs" data-api='["hue","lights","21,16","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="http://a.ze.gs/hue/lights/21,16/off?url=http://ha.ze.gs" data-api='["hue","lights","21,16","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Restroom">Restroom</td>
          <td><a href="http://a.ze.gs/hue/lights/10/on?url=http://ha.ze.gs" data-api='["hue","lights","10","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="http://a.ze.gs/hue/lights/10/off?url=http://ha.ze.gs" data-api='["hue","lights","10","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="Chiemi">Chiemi</td>
          <td><a href="http://a.ze.gs/hue/lights/18,19,20/on?url=http://ha.ze.gs" data-api='["hue","lights","18,19,20","on"]'>On</a></td>
          <td>&nbsp;</td>
          <td><a href="http://a.ze.gs/hue/lights/18,19,20/off?url=http://ha.ze.gs" data-api='["hue","lights","18,19,20","off"]'>Off</a></td>
        </tr>
        <tr>
          <td id="AC">
            <a href="#" data-status-action="control">A/C</a>
          </td>
          <td>
            <a
              href="http://a.ze.gs/switchbot-ac/-d/02-202307290753-22894539/-a/28,2,1,on?url=http://ha.ze.gs"
              data-api='["switchbot-ac","-d","02-202307290753-22894539","-a","28,2,1,on"]'
              data-status-action="cool"
              >Cool</a
            >
          </td>
          <td>
            <a
              href="http://a.ze.gs/switchbot-ac/-d/02-202307290753-22894539/-a/28,5,1,on?url=http://ha.ze.gs"
              data-api='["switchbot-ac","-d","02-202307290753-22894539","-a","28,5,1,on"]'
              data-status-action="hot"
              >Hot</a
            >
          </td>
          <td>
            <a
              href="http://a.ze.gs/switchbot-ac/-d/02-202307290753-22894539/-a/25,2,1,off?url=http://ha.ze.gs"
              data-api='["switchbot-ac","-d","02-202307290753-22894539","-a","25,2,1,off"]'
              data-status-action="off"
              >Off</a
            >
          </td>
        </tr>
        <tr>
          <td id="TatamiAC">Tatami A/C</td>
          <td><a href="http://a.ze.gs/switchbot-custom/-d/03-202401251013-58699638/-c/Cool?url=http://ha.ze.gs" data-api='["switchbot-custom","-d","03-202401251013-58699638","-c","Cool"]'>Cool</a></td>
          <td><a href="http://a.ze.gs/switchbot-custom/-d/03-202401251013-58699638/-c/Hot?url=http://ha.ze.gs" data-api='["switchbot-custom","-d","03-202401251013-58699638","-c","Hot"]'>Hot</a></td>
          <td><a href="http://a.ze.gs/switchbot-custom/-d/03-202401251013-58699638/-c/Off?url=http://ha.ze.gs" data-api='["switchbot-custom","-d","03-202401251013-58699638","-c","Off"]'>Off</a></td>
        </tr>
        <tr>
          <td>Tool</td>
          <td><a href="http://a.ze.gs/switchbot-command/-d/D23403D2D43D/-c/press?url=http://ha.ze.gs" data-api='["switchbot-command","-d","D23403D2D43D","-c","press"]'>HeatFloor</a></td>
          <td>&nbsp;</td>
          <td>
            <a
              href="http://a.ze.gs/google-home-speaker-wrapper/-h/192.168.1.22/-v/60/-s/%E3%83%81%E3%82%A8%E3%83%9F%E3%81%95%E3%82%93%E3%80%81%E3%83%9E%E3%83%9E%E3%81%95%E3%82%93%E3%80%81%E3%83%91%E3%83%91%E3%81%8C%E5%88%B0%E7%9D%80%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F%E3%80%82%E6%BA%96%E5%82%99%E3%82%92%E3%81%8A%E9%A1%98%E3%81%84%E3%81%97%E3%81%BE%E3%81%99%E3%80%82?url=http://ha.ze.gs"
              data-message-key="car-arrival"
              >CarArrives</a
            >
          </td>
        </tr>
        <tr>
          <td id="Fan">Fan</td>
          <td><a href="http://a.ze.gs/switchbot-command/-d/03-202401251013-89002900/-c/turnOn?url=http://ha.ze.gs" data-api='["switchbot-command","-d","03-202401251013-89002900","-c","turnOn"]'>On/Off</a></td>
          <td><a href="http://a.ze.gs/switchbot-command/-d/03-202401251013-89002900/-c/highSpeed?url=http://ha.ze.gs" data-api='["switchbot-command","-d","03-202401251013-89002900","-c","highSpeed"]'>Turbo</a></td>
          <td><a href="http://a.ze.gs/switchbot-command/-d/03-202401251013-89002900/-c/swing?url=http://ha.ze.gs" data-api='["switchbot-command","-d","03-202401251013-89002900","-c","swing"]'>Swing</a></td>
        </tr>
        <tr>
          <td id="NW">Nest WiFi</td>
          <td><a href="http://a.ze.gs/catt/-d/192.168.1.22/volumeup?url=http://ha.ze.gs" data-api='["catt","-d","host:nest","volumeup"]'>+</a></td>
          <td><a href="http://a.ze.gs/catt/-d/192.168.1.22/volumedown?url=http://ha.ze.gs" data-api='["catt","-d","host:nest","volumedown"]'>-</a></td>
          <td><a href="http://a.ze.gs/catt/-d/192.168.1.22/stop?url=http://ha.ze.gs" data-api='["catt","-d","host:nest","stop"]'>Off</a></td>
        </tr>
        <tr>
          <td id="TW">Tatami WiFi</td>
          <td><a href="http://a.ze.gs/catt/-d/192.168.1.236/volumeup?url=http://ha.ze.gs" data-api='["catt","-d","host:tatami","volumeup"]'>+</a></td>
          <td><a href="http://a.ze.gs/catt/-d/192.168.1.236/volumedown?url=http://ha.ze.gs" data-api='["catt","-d","host:tatami","volumedown"]'>-</a></td>
          <td><a href="http://a.ze.gs/catt/-d/192.168.1.236/stop?url=http://ha.ze.gs" data-api='["catt","-d","host:tatami","stop"]'>Off</a></td>
        </tr>
        <tr>
          <td id="CC">TV</td>
          <td><a href="http://a.ze.gs/catt/-d/192.168.1.219/volumeup?url=http://ha.ze.gs" data-api='["catt","-d","host:tv","volumeup"]'>+</a></td>
          <td><a href="http://a.ze.gs/catt/-d/192.168.1.219/volumedown?url=http://ha.ze.gs" data-api='["catt","-d","host:tv","volumedown"]'>-</a></td>
          <td><a href="http://a.ze.gs/catt/-d/192.168.1.219/stop?url=http://ha.ze.gs" data-api='["catt","-d","host:tv","stop"]'>Off</a></td>
        </tr>
        <tr>
          <td id="YouTube"><a href="#" data-youtube-key="tv">YouTube</a></td>
          <td><textarea id="youtube_url"></textarea></td>
          <td><a href="#" data-youtube-key="nest">Nest Wifi</a></td>
          <td><a href="#" data-youtube-key="tatami">Tatami WiFi</a></td>
        </tr>
        <tr>
          <td id="Voice">Voice</td>
          <td><textarea id="voicetext"></textarea></td>
          <td><a id="speak" href="#">Nest Wifi</a></td>
          <td><a id="speak_tatami" href="#">Tatami WiFi</a></td>
        </tr>
        <tr>
          <td id="Alarm">Alarm</td>
          <td>
            <select id="hour"></select>
            :
            <select id="min"></select>
          </td>
          <td><textarea id="alarmtext"></textarea></td>
          <td><a id="set" href="#">Set</a></td>
        </tr>
        <tr>
          <td id="AirCondition">AirCondition</td>
          <td id="Date">&nbsp;</td>
          <td id="Temperature">&nbsp;</td>
          <td id="Humid">&nbsp;</td>
        </tr>
      </tbody>
    </table>

    <script>const sanitizeText = (value) => encodeURIComponent(value.replace(/\s+/g, "　").trim());

const API_BASE_URL = "http://a.ze.gs";
const DEVICE_HOSTS = {
  nest: "192.168.1.22",
  tatami: "192.168.1.236",
  tv: "192.168.1.219",
};

const apiUrl = (args) => `${API_BASE_URL}/${args.join("/")}`;
const resolveHost = (value) => DEVICE_HOSTS[value] ?? value;
const replaceHostTokens = (args) =>
  args.map((arg) => (typeof arg === "string" && arg.startsWith("host:") ? resolveHost(arg.slice(5)) : arg));

const API_BASE_URL_VALUE = API_BASE_URL;

const ALARM_SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbyGtgeNC_rHFxPvSj7XjO5GdM6awoqlxJ7PDmfcadghjZshQ8Y/exec";

const buildAlarmUrl = (hour, minute, text) => {
  const sanitized = sanitizeText(text);
  return `${ALARM_SCRIPT_URL}?time=${hour}:${minute}:00&text=${sanitized}`;
};

const STATUS_SCRIPT_URL =
  "https://script.google.com/macros/s/AKfycbz61Wl_rfwYOuZ0z2z9qeegnIsanQeu6oI3Q3K5gX66Hgroaoz2z466ck9xMSvBfHpwUQ/exec";
const STATUS_CALLBACK = "__statusCallback";
const STATUS_KEYS = ["AirCondition", "Date", "Temperature", "Humid"];

const buildStatusUrl = (params = {}) => `${STATUS_SCRIPT_URL}?${new URLSearchParams(params)}`;

const parseLatestPayload = (payload) => {
  const cleaned = payload
    .replace(new RegExp(`^${STATUS_CALLBACK}&&${STATUS_CALLBACK}\\(`), "")
    .replace(/\);$/, "");
  const { conditions, status } = JSON.parse(cleaned);
  const latest = conditions?.pop?.();
  if (!latest) return null;
  const airCondition = status;
  return airCondition === undefined ? latest : { ...latest, AirCondition: airCondition };
};

const fetchLatestStatus = async (fetcher, { signal } = {}) => {
  const url = buildStatusUrl({ callback: STATUS_CALLBACK });
  const response = await (signal ? fetcher(url, { signal }) : fetcher(url));
  const payload = await response.text();
  return parseLatestPayload(payload);
};

const formatDateTimeLocal = (value) => {
  const parsed = new Date(value);
  if (Number.isNaN(parsed.getTime())) {
    return value;
  }
  return new Intl.DateTimeFormat("en-US", {
    month: "short",
    day: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false,
  })
    .format(parsed)
    .replace(",", "");
};

const updateStatusCells = (latest, elements) => {
  STATUS_KEYS.forEach((key) => {
    const value = latest[key];
    if (key === "AirCondition") {
      elements[key].innerText = value == null ? "AirCondition" : String(value);
      return;
    }
    if (key === "Date") {
      elements[key].innerText = formatDateTimeLocal(value);
      return;
    }
    elements[key].innerText = key === "Temperature" ? `${value}C` : `${value}%`;
  });
};

const STATUS_CELL_KEYS = STATUS_KEYS;

const VOICE_HOSTS = { speak: DEVICE_HOSTS.nest, speakTatami: DEVICE_HOSTS.tatami };
const CAR_ARRIVAL_MESSAGE = "チエミさん、ママさん、パパが到着しました。準備をお願いします。";
const MAX_VOICE_TEXT =
  "１２３４５６７８９０１２３４５６７８９０１２３４５６７８９０１２３４５６７８９０１２３４５６７８９０１２３４５６７８９０１２３４５６７８９０１２３４５６７８９０１２３４５６７８９０１２３4";
const MAX_ENCODED_LENGTH = encodeURIComponent(MAX_VOICE_TEXT).length;
const isVoiceTextTooLong = (voiceText) => sanitizeText(voiceText).length > MAX_ENCODED_LENGTH;

const buildVoiceUrls = (voiceText) => {
  const sanitized = sanitizeText(voiceText);
  return {
    speak: `${API_BASE_URL_VALUE}/google-home-speaker-wrapper/-h/${VOICE_HOSTS.speak}/-v/60/-s/${sanitized}`,
    speakTatami: `${API_BASE_URL_VALUE}/google-home-speaker-wrapper/-h/${VOICE_HOSTS.speakTatami}/-v/60/-s/${sanitized}`,
  };
};

const updateVoiceLinks = (voiceText, elements) => {
  if (isVoiceTextTooLong(voiceText)) {
    console.error(`Too long text : ${voiceText}`);
    if (elements.voicetext) {
      elements.voicetext.value = "";
    }
    return false;
  }
  const { speak, speakTatami } = buildVoiceUrls(voiceText);
  elements.speak.dataset.url = speak;
  elements.speakTatami.dataset.url = speakTatami;
  return true;
};

const buildCarArrivalArgs = () => [
  "google-home-speaker-wrapper",
  "-h",
  DEVICE_HOSTS.nest,
  "-v",
  60,
  "-s",
  sanitizeText(CAR_ARRIVAL_MESSAGE),
];

const YOUTUBE_HOSTS = new Set(["youtube.com", "www.youtube.com", "m.youtube.com", "music.youtube.com"]);

const parseYouTubeId = (youtubeUrl) => {
  if (!youtubeUrl) {
    return "";
  }
  try {
    const parsed = new URL(youtubeUrl);
    if (parsed.protocol !== "http:" && parsed.protocol !== "https:") {
      console.error(`Invalid URL: ${youtubeUrl}`);
      return "";
    }
    if (parsed.hostname === "youtu.be") {
      return parsed.pathname.split("/")[1] || "";
    }
    if (!YOUTUBE_HOSTS.has(parsed.hostname)) {
      console.error(`Invalid URL: ${youtubeUrl}`);
      return "";
    }

    const handlers = [
      {
        match: () => parsed.pathname === "/watch",
        getId: () => parsed.searchParams.get("v") || "",
      },
      {
        match: () => parsed.pathname.startsWith("/live/") || parsed.pathname.startsWith("/shorts/"),
        getId: () => parsed.pathname.split("/")[2] || "",
      },
    ];

    const handler = handlers.find(({ match }) => match());
    return handler ? handler.getId() : "";
  } catch {
    console.error(`Invalid URL: ${youtubeUrl}`);
    return "";
  }
};

const buildYouTubePlayUrl = (host, youtubeUrl) => {
  const videoId = parseYouTubeId(youtubeUrl);
  if (!videoId) {
    return null;
  }
  return `${API_BASE_URL_VALUE}/youtube-play/-h/${host}/-v/40/-i/${videoId}`;
};

const REQUIRED_IDS = ["voicetext", "speak", "speak_tatami", "hour", "min", "alarmtext", "set"];

const getRequiredElements = (doc, ids) => Object.fromEntries(ids.map((id) => [id, doc.getElementById(id)]));
const padTime = (value) => String(value).padStart(2, "0");
const buildTimeOptions = (count) =>
  Array.from({ length: count }, (_, index) => {
    const value = padTime(index);
    return `<option value="${value}">${value}</option>`;
  }).join("");

const parseApiCommands = (value) => {
  if (!value) return [];
  let parsed;
  try {
    parsed = JSON.parse(value);
  } catch (error) {
    console.error("Failed to parse data-api payload", error);
    throw error;
  }
  if (!Array.isArray(parsed)) {
    const error = new Error("Invalid data-api payload");
    console.error(error.message, parsed);
    throw error;
  }
  if (!parsed.length) return [];
  return parsed.every(Array.isArray) ? parsed : [parsed];
};

const setAlarmDefaults = (hourSelect, minuteSelect, now = new Date()) => {
  if (!hourSelect.options.length) {
    hourSelect.innerHTML = buildTimeOptions(24);
  }
  if (!minuteSelect.options.length) {
    minuteSelect.innerHTML = buildTimeOptions(60);
  }
  const setIfExists = (select, value) => {
    if (select.querySelector(`option[value="${value}"]`)) {
      select.value = value;
    }
  };
  setIfExists(hourSelect, padTime(now.getHours()));
  setIfExists(minuteSelect, padTime(now.getMinutes()));
};

const initApp = (doc, fetcher = fetch) => {
  const requiredElements = getRequiredElements(doc, REQUIRED_IDS);
  const statusCells = getRequiredElements(doc, STATUS_CELL_KEYS);
  if (Object.values(requiredElements).some((element) => !element)) {
    return null;
  }

  const { voicetext, speak, speak_tatami: speakTatami, hour, min, alarmtext, set: setButton } = requiredElements;
  const youtubeUrl = doc.getElementById("youtube_url");

  setAlarmDefaults(hour, min);

  voicetext.addEventListener("input", () => {
    updateVoiceLinks(voicetext.value, { speak, speakTatami, voicetext });
  });

  const setAlarm = () => fetcher(buildAlarmUrl(hour.value, min.value, alarmtext.value));
  const youtubePlay = (host) => {
    if (!youtubeUrl) {
      return null;
    }
    const playUrl = buildYouTubePlayUrl(host, youtubeUrl.value);
    if (!playUrl) {
      youtubeUrl.value = "";
      return null;
    }
    return fetcher(playUrl);
  };

  const fetchLatest = async (signal) => {
    if (Object.values(statusCells).some((element) => !element)) {
      return null;
    }
    const latest = await fetchLatestStatus(fetcher, { signal });
    updateStatusCells(latest, statusCells);
    return latest;
  };

  return {
    setAlarm,
    youtubePlay,
    fetchLatest,
    elements: {
      voicetext,
      speak,
      speakTatami,
      hour,
      min,
      alarmtext,
      setButton,
      youtubeUrl,
      statusCells,
    },
  };
};

const bindLinkClicks = (doc, selector, handler) => {
  doc.querySelectorAll(selector).forEach((link) => {
    link.addEventListener("click", (event) => {
      event.preventDefault();
      handler(link);
    });
  });
};

const DATA_API_DELAY_MS = 200;
const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
const STATUS_INTERVAL_MS = 10 * 60 * 1000;
const STATUS_BACKOFF_MS = 60 * 1000;

const scheduleLatestFetch = (fetchLatest, { onSchedule } = {}) => {
  let timerId;
  let controller;
  const schedule = (delayMs) => ((timerId = setTimeout(run, delayMs)), onSchedule?.(delayMs));
  const nextDelay = (error) =>
    error?.name === "AbortError" ? STATUS_INTERVAL_MS : STATUS_INTERVAL_MS + STATUS_BACKOFF_MS;
  const run = async () => {
    controller?.abort();
    controller = new AbortController();
    try {
      await fetchLatest(controller.signal);
      schedule(STATUS_INTERVAL_MS);
    } catch (error) {
      if (error?.name !== "AbortError") {
        console.error("Failed to fetch latest status", error);
      }
      schedule(nextDelay(error));
    }
  };
  run();
  return () => clearTimeout(timerId);
};

const wireEvents = (doc, fetcher, instance) => {
  const { setAlarm, youtubePlay, elements } = instance;

  elements.setButton.addEventListener("click", async (event) => {
    event.preventDefault();
    await setAlarm();
    elements.alarmtext.value = "";
  });

  elements.youtubeUrl.addEventListener("blur", () => {
    if (elements.youtubeUrl.value && !parseYouTubeId(elements.youtubeUrl.value)) {
      elements.youtubeUrl.value = "";
    }
  });

  bindLinkClicks(doc, "a[data-api], a[data-fetch], a[data-status-action], a[data-message-key]", async (link) => {
    if (link.dataset.api) {
      try {
        const apiCommands = parseApiCommands(link.dataset.api);
        for (let index = 0; index < apiCommands.length; index += 1) {
          await fetcher(apiUrl(replaceHostTokens(apiCommands[index])));
          if (DATA_API_DELAY_MS > 0 && index < apiCommands.length - 1) {
            await delay(DATA_API_DELAY_MS);
          }
        }
      } catch (error) {
        console.error("Failed to execute data-api commands", error);
        return;
      }
    }
    if (link.dataset.messageKey === "car-arrival") {
      await fetcher(apiUrl(buildCarArrivalArgs()));
    }
    if (link.dataset.fetch) {
      await fetcher(link.dataset.fetch);
    }
    if (link.dataset.statusAction) {
      await fetcher(buildStatusUrl({ s: "status", t: link.dataset.statusAction }));
    }
  });

  bindLinkClicks(doc, "a[data-youtube-host], a[data-youtube-key]", async (link) => {
    const host = link.dataset.youtubeHost ?? resolveHost(link.dataset.youtubeKey);
    if (!host) {
      return;
    }
    const result = await youtubePlay(host);
    if (result) {
      elements.youtubeUrl.value = "";
    }
  });

  [elements.speak, elements.speakTatami].forEach((link) => {
    link.addEventListener("click", async (event) => {
      event.preventDefault();
      if (link.dataset.url) {
        await fetcher(link.dataset.url);
        elements.voicetext.value = "";
      }
    });
  });
};

const start = (doc = document, fetcher = fetch) => {
  const instance = initApp(doc, fetcher);
  if (!instance) {
    return null;
  }

  const { fetchLatest } = instance;
  doc.querySelectorAll("a").forEach((link) => link.setAttribute("href", "#"));
  scheduleLatestFetch(fetchLatest);
  wireEvents(doc, fetcher, instance);

  return instance;
};

if (typeof window !== "undefined") {
  const instance = start(document, fetch);

  window.api = (args) => {
    fetch(apiUrl(args));
  };

  window.setAlarm = () => instance?.setAlarm();
  window.youtubePlay = (host) => instance?.youtubePlay(host);
}</script>
  </body>
</html>
